与比特币不同的是，以太坊使用一种名为 "权益证明"（PoS）的共识协议。这允许以太坊网络上的所有节点就区块链的当前状态达成一致，并确保网络免受各种攻击。
> 注意：在2022年9月15日之前，以太坊曾经使用工作证明（PoW）共识协议，正如比特币一样。网络的一次重大更新--俗称 "合并"，将共识协议从PoW更新为PoS。

## 什么是共识

梅里亚姆-韦伯斯特对 "共识 "一词的定义如下。

![Image](./img/i70BQqF.png)

## 什么是共识协议？

谈到像以太坊这样的区块链，本质上是分布式的去中心化数据库，网络节点需要就网络的当前状态达成协议。

共识协议帮助我们就网络在某一点上的状态达成协议，也就是共识。

虽然共识协议与构建dApps没有直接关系，但了解它们将帮助你理解很多其他的概念，并建立你的基础知识。

共识协议主要是经济系统，有助于防止某些类型的攻击。理论上，攻击者可以通过控制51%的网络来破坏共识。共识协议旨在使这种 "51%的攻击 "在经济上是不可行的。不同的机制以不同的方式来解决这个问题。

## 挖掘权益证明

利益证明是以太坊网络（和许多其他区块链）使用的共识机制的基础。其理念如下：

- 验证者以ETH代币的形式将资本投入到以太坊的智能合约中。
- 抵押的ETH作为抵押品，如果验证者有恶意行为（对状态撒谎，或行为懒散，即不回应请求），则可以被销毁。
- 然后验证者负责检查正在形成的新区块是否有效，并偶尔自己创建这些区块。

随着赌注的到位，作为验证者撒谎会导致你失去你的赌注资本。因此，验证者在经济上被激励不对他们的行为撒谎。

## PoS比PoW的优势

与工作证明相比，权益证明系统有多种改进。

- 大大减少了能源的使用--将以太坊从PoW转移到PoS，使世界的能源使用减少了0.2%。在整个世界的规模上，这是一个很大的能源节省。
- 更低的准入门槛 - 在PoW中，矿工需要拥有昂贵的专业硬件来生产新的区块。而PoS不再是这种情况，硬件要求更加 "普通工作 "可以承受。
- 减少中心化风险 - 由于在PoW中建立采矿场的成本和专业知识，以太坊是一个PoW网络，存在中心化风险。有了PoS，由于验证者只需要在前期投入一些资本，对硬件的要求更加合理，这应该会导致比PoW中更多的节点保证网络的安全。
- 减少ETH的发行--由于能源需求低，需要更少的ETH作为奖励来激励验证者，从而导致ETH的整体发行量减少，降低了网络的通货膨胀。
- 与PoW的硬件成本相比，51%的攻击的经济惩罚的成本是成倍增加的，因为前期需要投入资金。

## 产生区块

在权益证明下，验证者负责偶尔创建新区块。其余时间，他们验证其他验证者产生的区块。

要成为一个验证者，用户必须向存款合约存入32个ETH，并运行所需的节点软件--一个执行客户端、一个共识客户端和一个验证者客户端。

> 注意：虽然32个ETH看起来是运行一个验证器节点的高成本，但它大大低于矿工在PoW中的花费，也大大低于在其他PoS区块链上成为验证器的成本。

然后，验证者将收到来自以太坊网络上的对等人的新区块。验证者重新执行该区块的交易，并确认该区块是有效的。然后，他们在整个网络上发送一个支持该区块的证明（投票）。如果有足够的投票支持该区块，该区块就被添加到链上。这个过程会在未来的区块中重复进行。

每隔12秒，也就是以太坊上一个新区块的时间，就会随机选择一个验证者作为区块的提议者。如果被选为提议者，这个验证者负责创建一个新的区块并将其发送给其他节点，然后这些节点可以投票赞成或反对该区块。

## 网络安全

成为验证者是对帮助保护以太坊网络的承诺。验证者应保持足够的硬件、互联网连接和正常运行时间，以参与区块提议和验证。作为回报，验证者将获得ETH的奖励。

如果验证者未能履行其承诺，他们将错过ETH奖励。如果在被要求时未能参与（例如被要求对区块进行投票），他们就不能获得ETH奖励。如果他们有不诚实或恶意的行为，那么他们的股份也会被削减，导致经济损失，并被踢出验证人的行列。

恶意行为可能包括在一个12秒的时间段内提出多个区块，或在区块验证期间提交虚假证明。做这种恶意行为被砍掉的ETH数量取决于同一时间有多少其他验证者也被砍掉。这是因为一个验证者的网络连接断了，不应该有100个验证者协调起来对网络进行恶意攻击的惩罚。

## Sybil Resistance

从技术上讲，工作证明本身并不是一个共识协议--尽管为了简单起见，它经常被称为共识协议。它们实际上是抗塞比尔机制和区块生产者选择器--一种决定谁将成为最新区块的生产者的方法。

女巫攻击是指一个用户或团体假装成许多不同的用户的问题。对于一个去中心化的区块链来说，抵御这种类型的攻击是至关重要的，因为它允许矿工根据他们投入的资源获得奖励，而不仅仅是随机选择。

假设，如果我们只是通过随机选择而不是工作证明来选择一个区块的生产者，人们可以很容易地执行一个女巫攻击。

假设网络上有两个矿工。爱丽丝和鲍勃。通过随机选择，他们应该各自获得大约一半的采矿奖励。现在，查理出现了，但他假装是两个不同的用户--查理和达西。通过随机选择，查理最终会得到1/2的采矿奖励，因为他假装是两个不同的用户，而爱丽丝和鲍勃只得到1/4，而不是他们应该得到的1/3。

工作证明（Proof of Work）通过让矿工拿出大量的计算能力作为抵押，从而让他们耗费大量的电能，来防止女巫攻击。这是通过解决计算难题来证明矿工正在 "投入工作"。这对女巫攻击起到了经济威慑作用。

由于奖励是发放给成功的矿工的，而矿工的成功与他们在网络上的计算能力份额大致成正比，因此，如果你假装是1个用户或2个或100个用户，这已经不重要。你会得到相同数量的挖矿奖励，因为你的计算能力保持不变。

## 链的选择原则

偶尔，由于互联网延迟等问题，验证者有可能对区块链的头部（当前状态）有两个不同的看法，因此对什么是有效的新区块有两个不同的看法。这种情况的技术术语叫做分叉。

通常情况下，当网络以最佳方式诚实地运行时，链头只有一个区块，所有验证者对该状态达成一致。

在不同的验证器最终对链头有不同看法的情况下，有一种方法可以收敛到一个单一的链，因此也是一个单一的状态，这一点很重要。需要选择 "正确的链 "来防止状态的分裂和分叉的继续。

为了做到这一点，以太坊使用了一种名为LMD-GHOST的算法，该算法的作用是识别哪个分叉在其历史上拥有最大的证明。例如，如果链在某一点上分裂成两个分叉，而不同的验证者有不同的看法，LMD-GHOST将计算出这两个分叉中哪一个获得了更多的证明，即被网络上更多的验证者批准，然后所有验证者将趋向于从该分叉恢复，并与另一个分叉说再见。

偶尔，这种算法也意味着，作为临时分叉的一部分得到验证的交易，一旦分叉被替换成另一个分叉，就会回滚。这就引入了 "最终性 "的概念。

## 最终性（Finality）

在以太坊上，当一个交易是一个不能被改变的区块的一部分时，就具有 "最终性"，即该区块中的交易不能被回滚，至少不可行。

在PoS以太坊上，这是通过使用 "检查点 "块来管理的。每32个区块，称为一个纪元，就会产生一个检查点区块。除了对单个区块进行投票外，验证者还对每一个纪元的检查点区块对进行投票。

例如，如果n块是一个检查点区块，那么n+32块也是一个检查点区块。验证者对他们认为是有效的链的序列的一对（块n，块n+32）进行投票。如果有足够的票数支持这一对，那么：

较早的区块（区块n）被标记为最终确定。
后面的区块（区块n+32）被标记为合理的。

> 注意：早先的区块在纪元期间投票时必须已经有了理由（区块n-32，区块n）。

一旦一个区块进入最终确定的状态，攻击者将需要花费大量的金钱来试图恢复它。在权益证明系统中，如果你控制了整个权益的33%，理论上是可以改写一些历史的。因此，为了恢复一个已完成的区块，攻击者需要承诺损失至少三分之一的押注ETH总量。

具体来说，要做到这一点，攻击者可以投票反对一对检查点区块（区块n，区块n+32），永远不要让区块n被最终确定。

除了耗费大量资金外，共识机制确实有办法解决这个问题。如果超过四个纪元（128个区块）没有最终完成，网络就会开始削减试图投票反对多数人的少数人的抵押ETH，不让投票通过，让多数人重新获得权力并最终完成链。

## 弊端
然而，并不是所有的都是彩虹和独角兽。PoS有很多优点，但也有一些缺点，这使得共识机制成为一个活跃的研究和创新领域。

与工作证明相比，权益证明更年轻，更没有经过战斗的考验，工作证明自比特币创建以来一直经受着时间的考验。
从技术上讲，权益证明协议在代码中的实现要复杂得多，这也增加了可能出现的错误和问题的表面积。
由于这个原因，以太坊社区（和外部）的许多人仍在积极研究和工作，以不断改进共识机制。

## 资源

- [Proof of Stake FAQ by Vitalik Buterin](https://vitalik.ca/general/2017/12/31/pos_faq.html)
- [Why PoS Matters](https://bitcoinmagazine.com/culture/what-proof-of-stake-is-and-why-it-matters-1377531463)
- [LearnWeb3's older lesson on Proof of Work](https://github.com/LearnWeb3DAO/Sophomore-Track/blob/main/Proof-of-Work.md)
- [Why Proof of Stake by Vitalik Buterin](https://vitalik.ca/general/2020/11/06/pos2020.html)